<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CPR Trainer — Learn to Save a Life | Motion Arena</title>
    <meta name="description"
        content="Interactive CPR training game using phone sensors. Learn proper chest compression technique through real-time feedback.">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=JetBrains+Mono:wght@500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <!-- Canvas handles all visual states now -->

    <!-- Game Canvas -->
    <canvas id="gameCanvas"></canvas>

    <script src="/socket.io/socket.io.js"></script>
    <script src="game.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('session');
        const mode = params.get('mode') || '1p';

        const socket = io({
            transports: ['websocket', 'polling']
        });

        let gameStarted = false;

        // ─── REJOIN SESSION (laptop navigated from lobby → game page) ───
        if (sessionId) {
            socket.emit('rejoin-laptop', { sessionId }, (response) => {
                if (response.error) {
                    console.error('[CPR Trainer] Rejoin error:', response.error);
                    // Update canvas state to show error
                    if (typeof updateGameState === 'function') {
                        updateGameState({ phase: 'lobby', error: response.error });
                    }
                    return;
                }

                console.log('[CPR Trainer] Rejoined session:', response);

                // Always emit start-game so engine is created and ready for mobile player
                if (!gameStarted) {
                    gameStarted = true;
                    socket.emit('start-game');
                    console.log('[CPR Trainer] Emitted start-game to create engine');
                }

                // If already playing (reconnection), update state immediately
                if (response.state === 'playing') {
                    console.log('[CPR Trainer] Game already in progress');
                }
            });
        } else {
            // No session — solo/dev mode with keyboard only
            // Create a local state for keyboard-only play
            console.log('[CPR Trainer] No session — keyboard-only mode');
            if (typeof updateGameState === 'function') {
                updateGameState({
                    phase: 'playing',
                    timer: 60,
                    countdownTimer: 0,
                    player: { connected: false, ready: false },
                    compressions: { total: 0, currentBPM: 0, currentDepth: 0, currentRecoil: 0 },
                    scoring: { score: 0, grade: '-', rateScore: 0, depthScore: 0, recoilScore: 0, consistencyScore: 0, combo: 0, maxCombo: 0, perfectCount: 0, goodCount: 0, badCount: 0 },
                    feedback: 'Press SPACE to compress',
                    feedbackType: 'neutral',
                    events: [],
                    avgBPM: 0, avgDepth: 0, avgRecoil: 0,
                    tips: [],
                    waveform: []
                });
            }
        }

        // Listen for player joining
        socket.on('player-joined', (data) => {
            console.log('[CPR Trainer] Player joined:', data);
        });

        // Listen for game start signal from server
        socket.on('game-started', () => {
            console.log('[CPR Trainer] Game started signal received');
        });

        // CPR engine start signal — game is now counting down / playing
        socket.on('cpr-game-start', (data) => {
            console.log('[CPR Trainer] CPR game start signal — timer:', data.timer);
        });

        // Receive CPR game state from server engine
        socket.on('cpr-game-state', (data) => {
            // Update the global state variable used by game.js rendering
            if (typeof updateGameState === 'function') {
                updateGameState(data);
            }
        });

        // Session ended
        socket.on('session-ended', (data) => {
            alert(data.reason || 'Session ended');
            window.location.href = '/';
        });

        // ─── KEYBOARD: Spacebar → simulate compression ───
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                socket.emit('cpr-sim-compression');
            }
        });
    </script>
</body>

</html>