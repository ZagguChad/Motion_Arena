<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Motion Arena ‚Äî Lobby</title>
    <link rel="stylesheet" href="css/common.css">
    <style>
        .lobby {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 40px 24px;
            text-align: center;
        }

        .lobby-header {
            margin-bottom: 40px;
        }

        .lobby-header .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
            text-decoration: none;
            font-size: 0.85rem;
            margin-bottom: 20px;
            transition: color 0.3s;
        }

        .lobby-header .back-link:hover {
            color: var(--accent-cyan);
        }

        .lobby-header h1 {
            font-family: var(--font-retro);
            font-size: 1.4rem;
            margin-bottom: 8px;
            color: var(--accent-cyan);
            text-shadow: 0 0 20px rgba(0, 229, 255, 0.3);
        }

        .lobby-header p {
            color: var(--text-secondary);
            font-size: 0.95rem;
        }

        /* Mode Selection */
        .mode-select {
            display: flex;
            gap: 20px;
            margin-bottom: 40px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .mode-card {
            background: var(--bg-card);
            border: 2px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 32px 36px;
            cursor: pointer;
            transition: all 0.3s var(--ease-out);
            min-width: 220px;
            position: relative;
            overflow: hidden;
        }

        .mode-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: transparent;
            transition: background 0.3s;
        }

        .mode-card:hover {
            border-color: rgba(0, 229, 255, 0.3);
            transform: translateY(-4px);
            box-shadow: 0 8px 30px rgba(0, 229, 255, 0.1);
        }

        .mode-card.selected {
            border-color: var(--accent-cyan);
            box-shadow: 0 0 30px rgba(0, 229, 255, 0.15);
        }

        .mode-card.selected::before {
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-magenta));
        }

        .mode-card .mode-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .mode-card .mode-title {
            font-family: var(--font-retro);
            font-size: 0.65rem;
            color: var(--text-primary);
            letter-spacing: 2px;
            margin-bottom: 8px;
        }

        .mode-card .mode-desc {
            font-size: 0.8rem;
            color: var(--text-muted);
            line-height: 1.4;
        }

        .mode-card .mode-badge {
            display: inline-block;
            margin-top: 12px;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-family: var(--font-retro);
            letter-spacing: 1px;
        }

        .mode-card .mode-badge.solo {
            background: rgba(0, 229, 255, 0.1);
            color: var(--accent-cyan);
            border: 1px solid rgba(0, 229, 255, 0.2);
        }

        .mode-card .mode-badge.vs {
            background: rgba(255, 0, 229, 0.1);
            color: var(--accent-magenta);
            border: 1px solid rgba(255, 0, 229, 0.2);
        }

        /* QR Section */
        .qr-section {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 40px;
            margin-bottom: 40px;
            position: relative;
            overflow: hidden;
            display: none;
        }

        .qr-section.visible {
            display: block;
            animation: fadeIn 0.5s var(--ease-out);
        }

        .qr-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, var(--accent-cyan), var(--accent-magenta));
        }

        .qr-label {
            font-family: var(--font-retro);
            font-size: 0.6rem;
            color: var(--text-muted);
            letter-spacing: 3px;
            text-transform: uppercase;
            margin-bottom: 24px;
        }

        #qr-container {
            width: 280px;
            height: 280px;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.03);
            border-radius: var(--radius-md);
            border: 1px solid var(--border-subtle);
        }

        #qr-container img {
            width: 240px;
            height: 240px;
            image-rendering: pixelated;
        }

        .qr-url {
            font-family: monospace;
            font-size: 0.8rem;
            color: var(--accent-cyan);
            background: rgba(0, 229, 255, 0.05);
            padding: 8px 16px;
            border-radius: var(--radius-sm);
            border: 1px solid rgba(0, 229, 255, 0.1);
            word-break: break-all;
        }

        .qr-hint {
            margin-top: 16px;
            font-size: 0.8rem;
            color: var(--text-muted);
        }

        /* IP Selector */
        .ip-selector {
            margin-top: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
        }

        .ip-selector label {
            font-family: var(--font-retro);
            font-size: 0.45rem;
            color: var(--text-muted);
            letter-spacing: 1px;
        }

        .ip-selector select {
            background: var(--bg-secondary);
            color: var(--accent-cyan);
            border: 1px solid var(--border-accent);
            border-radius: var(--radius-sm);
            padding: 6px 12px;
            font-family: monospace;
            font-size: 0.8rem;
            cursor: pointer;
            outline: none;
        }

        .ip-selector select:focus {
            box-shadow: var(--glow-cyan);
        }

        /* Players Section */
        .players-section {
            display: none;
            gap: 24px;
            margin-bottom: 40px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .players-section.visible {
            display: flex;
            animation: fadeIn 0.5s var(--ease-out);
        }

        .player-slot {
            background: var(--bg-card);
            border: 1px solid var(--border-subtle);
            border-radius: var(--radius-lg);
            padding: 28px 36px;
            min-width: 220px;
            transition: all 0.4s var(--ease-out);
        }

        .player-slot.connected {
            border-color: rgba(0, 255, 136, 0.3);
            box-shadow: 0 0 20px rgba(0, 255, 136, 0.1);
        }

        .player-slot .player-label {
            font-family: var(--font-retro);
            font-size: 0.6rem;
            color: var(--text-muted);
            letter-spacing: 2px;
            margin-bottom: 12px;
        }

        .player-slot .player-icon {
            font-size: 2.5rem;
            margin-bottom: 12px;
        }

        .player-slot .player-status {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            font-size: 0.85rem;
        }

        .player-slot .player-status.waiting {
            color: var(--accent-yellow);
        }

        .player-slot .player-status.ready {
            color: var(--accent-green);
        }

        /* Start Button */
        #start-btn {
            display: none;
        }

        #start-btn.visible {
            display: inline-flex;
            animation: fadeIn 0.5s var(--ease-out);
        }

        /* Session Info */
        .session-info {
            font-family: var(--font-retro);
            font-size: 0.55rem;
            color: var(--text-muted);
            letter-spacing: 2px;
            margin-top: 20px;
            display: none;
        }

        .session-info.visible {
            display: block;
        }

        .session-info span {
            color: var(--accent-cyan);
        }

        /* Loading */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-subtle);
            border-top-color: var(--accent-cyan);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>

<body>

    <div class="lobby">
        <div class="lobby-header">
            <a href="index.html" class="back-link">‚Üê Back to Games</a>
            <h1 id="game-title">GASTRO TETRIS</h1>
            <p id="game-desc">Choose your game mode</p>
        </div>

        <!-- Mode Selection -->
        <div class="mode-select" id="mode-select">
            <div class="mode-card" id="mode-1p" onclick="selectMode('1p')">
                <div class="mode-icon">üßë</div>
                <div class="mode-title">SOLO MODE</div>
                <div class="mode-desc">Play alone using gesture controls from your phone</div>
                <div class="mode-badge solo">1 PLAYER</div>
            </div>
            <div class="mode-card" id="mode-2p" onclick="selectMode('2p')">
                <div class="mode-icon">‚öîÔ∏è</div>
                <div class="mode-title">VS MODE</div>
                <div class="mode-desc">Compete head-to-head! Two phones, two boards</div>
                <div class="mode-badge vs">2 PLAYERS</div>
            </div>
        </div>

        <!-- QR Section (hidden until mode selected) -->
        <div class="qr-section" id="qr-section">
            <div class="qr-label" id="qr-label">üì± Scan to Join</div>
            <div id="qr-container">
                <div class="loading-spinner"></div>
            </div>
            <div class="qr-url" id="join-url">Generating link...</div>
            <div class="qr-hint" id="qr-hint">Scan this QR code with your phone camera</div>
            <div class="ip-selector">
                <label>NETWORK:</label>
                <select id="ip-select" onchange="switchIP(this.value)"></select>
            </div>
        </div>

        <!-- Player Slots (dynamic) -->
        <div class="players-section" id="players-section">
            <div class="player-slot" id="player1-slot">
                <div class="player-label">PLAYER 1</div>
                <div class="player-icon">üéÆ</div>
                <div class="player-status waiting" id="player1-status">
                    <span class="status-dot waiting"></span>
                    Waiting...
                </div>
            </div>
            <div class="player-slot" id="player2-slot" style="display: none;">
                <div class="player-label">PLAYER 2</div>
                <div class="player-icon">üéÆ</div>
                <div class="player-status waiting" id="player2-status">
                    <span class="status-dot waiting"></span>
                    Waiting...
                </div>
            </div>
        </div>

        <button class="btn btn-start" id="start-btn" onclick="startGame()">
            üöÄ START GAME
        </button>

        <div class="session-info" id="session-info">
            Session: <span id="session-id">‚Äî</span>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        const socket = io();
        let sessionId = null;
        let selectedMode = null;
        let currentIP = null;
        let allIPs = [];

        // Game names mapping
        const gameNames = {
            'gastro-tetris': { title: 'GASTRO TETRIS', desc: 'Gesture-controlled Tetris' },
            'dino-dash': { title: 'KNIGHT DASH', desc: 'Jump in real life to play!' },
            'ghost-breath': { title: 'GHOST OF THE BREATH TEMPLE', desc: 'Breathe to keep the flame alive!' },
            'cpr-trainer': { title: 'CPR TRAINER', desc: 'Practice life-saving CPR compressions!' },
            'tower-siege': { title: 'TOWER SIEGE', desc: 'Push-up powered tower warfare!' },
            'focus-mode': { title: 'FOCUS MODE', desc: '25-min Pomodoro with posture tracking' },
            'plank-wars': { title: 'PLANK WARS', desc: '60-second plank challenge!' },
            'gravity-bridge': { title: 'GRAVITY BRIDGE', desc: 'Sync your bodies to cross the bridge!' },

            'balance-duel': { title: 'BALANCE DUEL', desc: 'Keep the crystal stable together!' }
        };

        // Get game from URL
        const params = new URLSearchParams(window.location.search);
        const game = params.get('game') || 'gastro-tetris';

        // Set game info
        const gameInfo = gameNames[game] || { title: game.toUpperCase(), desc: 'Motion Arena Game' };
        document.getElementById('game-title').textContent = gameInfo.title;

        // === MODE SELECTION ===
        function selectMode(mode) {
            selectedMode = mode;

            // Update card UI
            document.querySelectorAll('.mode-card').forEach(c => c.classList.remove('selected'));
            document.getElementById(`mode-${mode}`).classList.add('selected');

            // Update hint text
            const descMap = {
                'gastro-tetris': { solo: 'Solo gesture-controlled Tetris', vs: '2-Player competitive Tetris' },
                'dino-dash': { solo: 'Jump to dodge obstacles!', vs: 'Jump to dodge obstacles!' },
                'ghost-breath': { solo: 'Match breathing rhythms to keep the flame alive!', vs: 'Match breathing rhythms to keep the flame alive!' },
                'cpr-trainer': { solo: 'Practice CPR with real-time feedback!', vs: 'Practice CPR with real-time feedback!' },
                'tower-siege': { solo: 'Battle AI General Crimson!', vs: '1v1 Push-up battle!' },
                'focus-mode': { solo: '25-min Pomodoro with posture + breath', vs: 'Group focus session!' },
                'plank-wars': { solo: 'Solo plank challenge!', vs: 'LAN plank competition!' },
                'gravity-bridge': { solo: 'Solo bridge crossing!', vs: 'Co-op bridge crossing!' },

                'balance-duel': { solo: 'Solo balance!', vs: 'Co-op crystal balance!' }
            };
            const descs = descMap[game] || { solo: 'Solo mode', vs: 'Versus mode' };

            if (mode === '1p') {
                document.getElementById('qr-hint').textContent = 'Scan this QR code with your phone';
                document.getElementById('qr-label').textContent = 'üì± Scan to Play';
                document.getElementById('game-desc').textContent = descs.solo;
                // Show only player 1 slot
                document.getElementById('player2-slot').style.display = 'none';
            } else {
                document.getElementById('qr-hint').textContent = 'Both players scan this QR code with their phones';
                document.getElementById('qr-label').textContent = 'üì± Scan to Join';
                document.getElementById('game-desc').textContent = descs.vs;
                // Show both player slots
                document.getElementById('player2-slot').style.display = '';
            }

            // Create session with mode
            createSession(mode);
        }

        function createSession(mode) {
            socket.emit('create-session', { game, mode }, (response) => {
                sessionId = response.sessionId;
                document.getElementById('session-id').textContent = sessionId;
                document.getElementById('session-info').classList.add('visible');

                // Show QR and players sections
                document.getElementById('qr-section').classList.add('visible');
                document.getElementById('players-section').classList.add('visible');

                // Reset player states
                resetPlayerSlots();

                // Fetch QR code and IPs
                fetch('/api/ip')
                    .then(res => res.json())
                    .then(ipData => {
                        currentIP = ipData.ip;
                        allIPs = ipData.allIPs || [];

                        // Populate IP dropdown
                        const select = document.getElementById('ip-select');
                        select.innerHTML = '';
                        allIPs.forEach(entry => {
                            const opt = document.createElement('option');
                            opt.value = entry.ip;
                            opt.textContent = `${entry.ip} (${entry.name}${entry.virtual ? ' - virtual' : ''})`;
                            if (entry.ip === currentIP) opt.selected = true;
                            select.appendChild(opt);
                        });

                        generateQRForIP(currentIP);
                    });
            });
        }

        function resetPlayerSlots() {
            // Reset player 1
            document.getElementById('player1-slot').classList.remove('connected');
            document.getElementById('player1-status').className = 'player-status waiting';
            document.getElementById('player1-status').innerHTML = '<span class="status-dot waiting"></span> Waiting...';

            // Reset player 2
            document.getElementById('player2-slot').classList.remove('connected');
            document.getElementById('player2-status').className = 'player-status waiting';
            document.getElementById('player2-status').innerHTML = '<span class="status-dot waiting"></span> Waiting...';

            // Hide start button
            document.getElementById('start-btn').classList.remove('visible');
        }

        async function generateQRForIP(ip) {
            if (!sessionId) return;
            const resp = await fetch(`/api/qr/${sessionId}?ip=${ip}&game=${game}`);
            const data = await resp.json();
            document.getElementById('qr-container').innerHTML = `<img src="${data.qr}" alt="QR Code">`;
            document.getElementById('join-url').textContent = data.url;
        }

        function switchIP(ip) {
            currentIP = ip;
            generateQRForIP(ip);
        }

        // === SOCKET EVENTS ===
        // Player joined
        socket.on('player-joined', (data) => {
            const slot = document.getElementById(`player${data.playerNum}-slot`);
            const status = document.getElementById(`player${data.playerNum}-status`);

            slot.classList.add('connected');
            status.className = 'player-status ready';
            status.innerHTML = '<span class="status-dot connected"></span> Connected!';

            // Show start button when enough players joined
            if (selectedMode === '1p' && data.totalPlayers >= 1) {
                document.getElementById('start-btn').classList.add('visible');
            } else if (selectedMode === '2p' && data.totalPlayers >= 2) {
                document.getElementById('start-btn').classList.add('visible');
            }
        });

        // Player left
        socket.on('player-left', (data) => {
            const slot = document.getElementById(`player${data.playerNum}-slot`);
            const status = document.getElementById(`player${data.playerNum}-status`);

            slot.classList.remove('connected');
            status.className = 'player-status waiting';
            status.innerHTML = '<span class="status-dot waiting"></span> Waiting...';

            document.getElementById('start-btn').classList.remove('visible');
        });

        // Session ready
        socket.on('session-ready', () => {
            document.getElementById('start-btn').classList.add('visible');
        });

        // Start game
        function startGame() {
            socket.emit('start-game');

            // Navigate to game page with mode
            const gamePages = {
                'gastro-tetris': `tetris.html?session=${sessionId}&mode=${selectedMode}`,
                'dino-dash': `dino-dash/game.html?session=${sessionId}&mode=${selectedMode}`,
                'ghost-breath': `ghost-breath/game.html?session=${sessionId}&mode=${selectedMode}`,
                'cpr-trainer': `cpr-trainer/game.html?session=${sessionId}&mode=${selectedMode}`,
                'tower-siege': `tower-siege/game.html?session=${sessionId}&mode=${selectedMode}`,
                'focus-mode': `focus-mode/game.html?session=${sessionId}&mode=${selectedMode}`,
                'plank-wars': `plank-wars/game.html?session=${sessionId}&mode=${selectedMode}`,
                'gravity-bridge': `gravity-bridge/game.html?session=${sessionId}&mode=${selectedMode}`,

                'balance-duel': `balance-duel/game.html?session=${sessionId}&mode=${selectedMode}`
            };
            window.location.href = gamePages[game] || `tetris.html?session=${sessionId}&mode=${selectedMode}`;
        }

        // Auto-select solo mode for single-player-only games
        const soloOnlyGames = ['dino-dash', 'ghost-breath', 'cpr-trainer', 'focus-mode'];
        if (soloOnlyGames.includes(game)) {
            // Hide mode selection, auto-select 1p
            document.getElementById('mode-select').style.display = 'none';
            selectMode('1p');
        }
    </script>

</body>

</html>