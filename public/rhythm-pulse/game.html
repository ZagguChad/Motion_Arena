<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rhythm Pulse | Motion Arena</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&family=Inter:wght@400;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <div class="waiting-overlay" id="waiting-overlay">
        <div class="game-emoji">üéµ</div>
        <h1>RHYTHM PULSE</h1>
        <p class="subtitle" id="waiting-status">Waiting for players...</p>
        <div class="loading-spinner"></div>
        <p class="waiting-info">Both players scan QR with phone</p>
    </div>

    <div class="game-container">
        <canvas id="gameCanvas"></canvas>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script src="game.js"></script>
    <script>
        const params = new URLSearchParams(window.location.search);
        const sessionId = params.get('session');
        const mode = params.get('mode') || '2p';

        const socket = io({ transports: ['websocket', 'polling'] });
        const canvas = document.getElementById('gameCanvas');
        const waitingStatus = document.getElementById('waiting-status');
        let gameStarted = false;
        let playersConnected = 0;

        const game = new RhythmPulseGame(canvas);

        if (sessionId) {
            socket.emit('rejoin-laptop', { sessionId }, (response) => {
                if (response.error) {
                    waitingStatus.innerHTML = `<span style="color:#ff4466;">‚ùå ${response.error}</span>`;
                    return;
                }
                if (response.state === 'playing') {
                    startGameUI();
                } else if (response.players && response.players.length >= 2) {
                    waitingStatus.innerHTML = '<span style="color:#44ff88;">‚úÖ Both players connected!</span>';
                    setTimeout(() => startGameUI(), 1000);
                } else if (response.players) {
                    playersConnected = response.players.length;
                    waitingStatus.innerHTML = `<span style="color:#ffdd00;">‚è≥ ${playersConnected}/2 players</span>`;
                }
            });
        } else {
            waitingStatus.innerHTML = '<span style="color:#8866cc;">No session ‚Äî Demo mode (Space = squat)</span>';
            setTimeout(() => startGameUI(), 1500);
        }

        socket.on('player-joined', (data) => {
            playersConnected = data.totalPlayers;
            waitingStatus.innerHTML = `<span style="color:#ffdd00;">‚è≥ ${playersConnected}/2 players</span>`;
            if (playersConnected >= 2) {
                waitingStatus.innerHTML = '<span style="color:#44ff88;">‚úÖ Both players connected!</span>';
            }
        });

        socket.on('game-started', () => startGameUI());

        socket.on('rp-squat', (data) => {
            game.onPlayerSquat(data.playerNum, data.quality, data.combo, data.timestamp);
        });

        socket.on('session-ended', (data) => {
            alert(data.reason || 'Session ended');
            window.location.href = '/';
        });

        function startGameUI() {
            if (gameStarted) return;
            gameStarted = true;
            socket.emit('start-game');
            document.getElementById('waiting-overlay').classList.add('hidden');
            game.start();
        }

        // Keyboard fallback
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && gameStarted) {
                e.preventDefault();
                game.onPlayerSquat(1, 'perfect', 0, Date.now());
                game.onPlayerSquat(2, 'perfect', 0, Date.now());
            }
        });
    </script>
</body>

</html>